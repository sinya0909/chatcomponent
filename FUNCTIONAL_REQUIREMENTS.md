# Chatコンポーネント 機能要件書（WIP版）

## 目的
本書はWIP版での機能肥大を防ぐため、現在決定済みの機能要件のみを記載する。

## 基本設計方針

### アーキテクチャ
- **パターン**: Children継承（Compound Components）
- **スコープ**: 単一チャットルーム
- **通信**: Ably/WebSocket前提の双方向通信
- **認証**: 外部管理（コンポーネント内では認証機能不要）

### コンポーネント構造
```typescript
<Chat ablyConfig={config} roomId="general">
  <Chat.MessageList />
  <Chat.MessageInput currentUser={user} />
  <Chat.TypingIndicator />
  <Chat.OnlineUsers />
</Chat>
```

## 機能要件

### 1. リアルタイムメッセージ送受信

#### メッセージ送信機能
- **入力方式**: テキスト入力フィールド
- **送信トリガー**: 
  - Enterキー押下
  - 送信ボタンクリック
  - Shift+Enterで改行
- **送信前検証**: 空メッセージの送信防止
- **送信状態表示**: 送信中インジケーター

#### メッセージ受信機能
- **リアルタイム受信**: Ablyチャンネル経由
- **自動表示**: 新着メッセージの即座反映
- **重複防止**: 同じメッセージIDの重複受信回避

#### エラーハンドリング
- **送信失敗**: リトライ機能
- **接続切断**: 再接続時の未送信メッセージ処理

### 2. メッセージ履歴表示

#### 履歴取得・表示
- **初期読み込み**: ルーム参加時の過去メッセージ取得
- **表示順序**: 時系列順（古い→新しい）
- **表示件数**: 適切なページング（例：直近50件）
- **追加読み込み**: スクロール上端での過去メッセージ読み込み

#### メッセージ表示形式
- **送信者識別**: 自分/他人の区別表示
- **タイムスタンプ**: 送信時刻表示
- **ユーザー情報**: 送信者名・アバター

#### スクロール制御
- **特定メッセージへのスクロール**: `message_id` 指定でのスクロール移動
- **メッセージハイライト**: スクロール先メッセージの一時的なハイライト
- **API提供**: `scrollToMessage(messageId)` のような外部制御
- **履歴読み込み時**: スクロール位置保持
- **任意スクロール**: ユーザーの自由なスクロール操作を妨げない

#### パフォーマンス
- **仮想化**: 大量メッセージ時の仮想スクロール
- **メモリ管理**: 表示外メッセージの適切な管理

### 3. 通知機能の呼び出し
- **新着メッセージ通知**: 他人からのメッセージ受信時のイベント発火
- **未読数変更通知**: 未読メッセージ数の増減時のイベント発火
- **タブアクティブ状態管理**: フォーカス状態の判定・提供
- **モック通知機能**: 開発・デモ用の通知機能
- **責務分離**: 実際の通知表示は親アプリケーションに委譲

### 4. 双方向通信の前提
- **Ablyチャンネル**: roomId ベースのチャンネル購読
- **メッセージ配信**: publish/subscribe パターン
- **接続状態**: 接続/切断の状態管理

## 将来的機能（現時点）
- メッセージの編集・削除
- ファイル・画像送信

---
*作成日: 2025-07-24*
*ステータス: WIP版要件*